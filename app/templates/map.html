{% extends "base.html" %}

{% block title %}徐州旅游地图{% endblock %}

{% block extra_css %}
<style>
    #map-container {
        height: 600px;
        width: 100%;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .map-controls {
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .map-category {
        margin-bottom: 10px;
    }
    
    .map-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 20px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-right: 15px;
    }
    
    .legend-color {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        margin-right: 5px;
    }
    
    .location-list {
        max-height: 600px;
        overflow-y: auto;
        padding-right: 10px;
    }
    
    /* 位置列表项样式 */
    .list-location-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .list-location-item:hover {
        background-color: #f8f9fa;
    }
    
    .list-location-item.active {
        background-color: #e9f5ff;
        border-left: 3px solid #007bff;
    }
    
    /* 移动端优化 */
    @media (max-width: 768px) {
        #map-container {
            height: 400px;
        }
        
        .location-list {
            margin-top: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">徐州旅游地图</h1>
    <p class="lead mb-4">探索徐州各个景点、美食和实用位置，规划您的完美行程。</p>
    
    <div class="row">
        <div class="col-md-9">
            <!-- 地图控制区 -->
            <div class="map-controls">
                <h5 class="mb-3">地图筛选</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="map-category">
                            <label class="form-label">位置类型</label>
                            <select class="form-select" id="location-type">
                                <option value="all">所有位置</option>
                                <option value="attraction">景点</option>
                                <option value="food">美食</option>
                                <option value="traffic">交通</option>
                                <option value="shopping">购物</option>
                                <option value="medical">医疗</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="map-search">
                            <label class="form-label">搜索地点</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="map-search-input" placeholder="输入地点名称...">
                                <button class="btn btn-primary" id="map-search-btn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="map-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span>景点</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3498db;"></div>
                        <span>美食</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2ecc71;"></div>
                        <span>交通</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f39c12;"></div>
                        <span>购物</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #9b59b6;"></div>
                        <span>医疗</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #34495e;"></div>
                        <span>其他</span>
                    </div>
                </div>
            </div>
            
            <!-- 地图容器 -->
            <div id="map-container"></div>
            
            <!-- 位置信息 -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0" id="selected-location-title">选中的位置信息</h5>
                </div>
                <div class="card-body" id="location-info">
                    <p class="text-muted">请从地图上选择一个位置查看详细信息</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <!-- 位置列表 -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0" id="location-list-title">所有位置</h5>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush location-list" id="location-list">
                        <!-- 位置列表将通过JavaScript动态生成 -->
                        <li class="list-group-item text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- 百度地图API -->
<script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=nSxiPohfziUaCuONe4ViUP2N"></script>

<!-- 离线模式支持 -->
<script>
// 标记是否处于离线模式
let isOfflineMode = false;

// 检查百度地图API是否成功加载
window.addEventListener('load', function() {
    setTimeout(function() {
        if (typeof BMap === 'undefined') {
            console.log('百度地图API加载失败，切换到离线模式');
            isOfflineMode = true;
            activateOfflineMode();
        }
    }, 3000); // 3秒后检查
});

// 激活离线模式
function activateOfflineMode() {
    const mapContainer = document.getElementById('map-container');
    if (!mapContainer) return;
    
    // 从URL获取位置参数
    const urlParams = new URLSearchParams(window.location.search);
    const name = urlParams.get('name');
    const address = urlParams.get('address');
    
    // 生成离线模式UI
    let offlineContent = `
        <div class="card">
            <div class="card-header bg-warning">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <h5 class="mb-0">地图服务暂时不可用</h5>
                </div>
            </div>
            <div class="card-body text-center">
                <div class="mb-4">
                    <i class="fas fa-map-marked-alt" style="font-size: 80px; color: #ccc;"></i>
                </div>
                <p class="lead">无法连接到百度地图服务，以下是位置信息：</p>
                ${name ? `<h4 class="mt-3">${name}</h4>` : ''}
                ${address ? `<p><i class="fas fa-map-marker-alt text-danger me-2"></i>${address}</p>` : ''}
                
                <div class="mt-4">
                    <p>您可以尝试以下方式：</p>
                    <div class="d-flex justify-content-center gap-2">
                        <button class="btn btn-primary" onclick="window.location.reload()">
                            <i class="fas fa-sync-alt me-2"></i>重新加载
                        </button>
                        <a href="/" class="btn btn-outline-secondary">
                            <i class="fas fa-home me-2"></i>返回首页
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 替换地图容器内容
    mapContainer.innerHTML = offlineContent;
    
    // 禁用地图控件
    document.querySelectorAll('.map-controls').forEach(control => {
        control.classList.add('disabled');
        control.innerHTML = `
            <div class="alert alert-warning mb-0">
                <i class="fas fa-exclamation-triangle me-2"></i>
                地图功能暂时不可用，请稍后再试
            </div>
        `;
    });
    
    // 加载离线位置列表
    loadOfflineLocationList();
}

// 加载离线位置列表
function loadOfflineLocationList() {
    const locationList = document.getElementById('location-list');
    if (!locationList) return;
    
    // 从URL获取位置参数
    const urlParams = new URLSearchParams(window.location.search);
    const name = urlParams.get('name');
    
    // 创建静态位置列表
    const offlineLocations = [
        { name: '云龙山风景区', address: '徐州市云龙区', type: 'attraction' },
        { name: '龟山汉墓', address: '徐州市云龙区龟山路2号', type: 'attraction' },
        { name: '徐州博物馆', address: '徐州市云龙区和平路118号', type: 'attraction' },
        { name: '彭祖园', address: '徐州市泉山区彭祖大道1号', type: 'attraction' },
        { name: '老玖烧烤', address: '徐州和平路', type: 'food' },
        { name: '徐州羊汤', address: '徐州市泉山区', type: 'food' },
        { name: '徐州火车站', address: '徐州市云龙区', type: 'traffic' }
    ];
    
    // 生成HTML
    let html = '';
    offlineLocations.forEach((location, index) => {
        // 获取图标类型
        let iconClass = 'fa-map-marker-alt';
        let iconColor = 'text-secondary';
        
        if (location.type === 'attraction') {
            iconClass = 'fa-landmark';
            iconColor = 'text-danger';
        } else if (location.type === 'food') {
            iconClass = 'fa-utensils';
            iconColor = 'text-primary';
        } else if (location.type === 'traffic') {
            iconClass = 'fa-bus';
            iconColor = 'text-success';
        }
        
        // 检查是否是当前位置
        const isActive = name && location.name === name;
        const activeClass = isActive ? 'active' : '';
        
        html += `
            <li class="list-group-item list-location-item ${activeClass}">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">
                        <i class="fas ${iconClass} ${iconColor} me-2"></i>${location.name}
                    </h6>
                </div>
                <small class="text-muted d-block text-truncate">${location.address}</small>
            </li>
        `;
    });
    
    // 设置列表内容
    locationList.innerHTML = html;
    
    // 更新位置信息卡片
    if (name) {
        const selectedLocation = offlineLocations.find(loc => loc.name === name);
        if (selectedLocation) {
            updateOfflineLocationInfo(selectedLocation);
        }
    }
}

// 更新离线位置信息
function updateOfflineLocationInfo(location) {
    const locationInfo = document.getElementById('location-info');
    const locationTitle = document.getElementById('selected-location-title');
    
    if (!locationInfo || !locationTitle) return;
    
    // 更新标题
    locationTitle.textContent = location.name;
    
    // 构建信息HTML
    let html = `
        <h5>${location.name}</h5>
        <p><i class="fas fa-map-marker-alt text-danger me-2"></i>${location.address}</p>
        <div class="alert alert-info mt-3">
            <i class="fas fa-info-circle me-2"></i>
            离线模式下无法显示完整的位置信息，请恢复网络连接后查看
        </div>
    `;
    
    // 更新信息区域
    locationInfo.innerHTML = html;
}
</script>

<!-- 备用地图API引用 -->
<script>
// 如果主API加载失败，尝试使用备用API
setTimeout(function() {
    if (typeof BMap === 'undefined' && !isOfflineMode) {
        console.log('尝试加载备用百度地图API...');
        const script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = 'https://api.map.baidu.com/getscript?v=3.0&ak=nSxiPohfziUaCuONe4ViUP2N&services=&t=' + Date.now();
        document.body.appendChild(script);
        
        // 检查备用API是否加载成功
        script.onload = function() {
            console.log('备用API加载成功，正在初始化地图...');
            if (typeof BMap !== 'undefined') {
                // 尝试初始化地图
                try {
                    initMap();
                    loadLocations();
                } catch (e) {
                    console.error('地图初始化失败:', e);
                    activateOfflineMode();
                }
            }
        };
        
        script.onerror = function() {
            console.error('备用API加载失败，切换到离线模式');
            activateOfflineMode();
        };
    }
}, 4000); // 4秒后尝试加载备用API
</script>

    // 地图实例和标记点集合
    let map;
    let markers = [];
    let currentLocations = [];
    let infoWindow;
    
    // 类型对应的颜色
    const typeColors = {
        'attraction': '#e74c3c',  // 红色
        'food': '#3498db',        // 蓝色
        'traffic': '#2ecc71',     // 绿色
        'shopping': '#f39c12',    // 黄色
        'medical': '#9b59b6',     // 紫色
        'other': '#34495e'        // 深灰色
    };
    
    // 初始化地图
    function initMap() {
        // 创建地图实例
        map = new BMap.Map("map-container");
        
        // 徐州市中心坐标 - 更新为精确坐标
        const xuzhou = new BMap.Point(117.20111, 34.273194);
        
        // 设置中心点和缩放级别
        map.centerAndZoom(xuzhou, 15);
        
        // 添加地图控件
        map.addControl(new BMap.NavigationControl());
        map.addControl(new BMap.ScaleControl());
        map.addControl(new BMap.OverviewMapControl());
        map.enableScrollWheelZoom();
        
        // 添加默认位置标记
        const centerMarker = new BMap.Marker(xuzhou);
        map.addOverlay(centerMarker);
        centerMarker.setAnimation(BMAP_ANIMATION_BOUNCE); // 设置跳动动画
        
        // 创建信息窗口
        const centerInfoWindow = new BMap.InfoWindow(
            "<div style='padding:8px;'>" +
            "<h5 style='margin-bottom:5px;font-weight:bold;'>徐州中心位置</h5>" + 
            "<p style='margin:0;'>坐标：34°16'23.5\"N 117°12'04.0\"E</p>" +
            "</div>"
        );
        
        // 添加点击事件
        centerMarker.addEventListener("click", function(){
            this.openInfoWindow(centerInfoWindow);
        });
        
        // 创建全局信息窗口用于显示位置信息
        infoWindow = new BMap.InfoWindow("");
        
        // 处理URL参数，如果有位置参数，直接定位到指定位置
        handleUrlParams();

        // 加载坐标点数据
        loadLocations();

        // 初始化事件监听
        initEventListeners();
    }
    
    // 处理URL参数，支持从其他页面跳转并定位到特定位置
    function handleUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        const name = urlParams.get('name');
        const address = urlParams.get('address');
        const lat = parseFloat(urlParams.get('lat'));
        const lng = parseFloat(urlParams.get('lng'));
        
        if (name && address && !isNaN(lat) && !isNaN(lng)) {
            console.log(`从URL参数定位到: ${name}, 坐标: ${lat},${lng}`);
            
            // 创建一个高亮标记
            const point = new BMap.Point(lng, lat);
            const highlightMarker = new BMap.Marker(point);
            map.addOverlay(highlightMarker);
            
            // 设置动画效果
            highlightMarker.setAnimation(BMAP_ANIMATION_BOUNCE);
            
            // 设置地图中心点和缩放级别
            map.centerAndZoom(point, 16);
            
            // 创建信息窗口
            const customInfoWindow = new BMap.InfoWindow(
                "<div style='padding:8px;'>" +
                `<h5 style='margin-bottom:5px;font-weight:bold;'>${name}</h5>` + 
                `<p style='margin:0;'>${address}</p>` +
                "</div>"
            );
            
            // 自动打开信息窗口
            highlightMarker.openInfoWindow(customInfoWindow);
            
            // 在加载位置列表后，高亮对应的列表项
            setTimeout(function() {
                highlightLocationInList(name);
            }, 1000);
        }
    }
    
    // 在位置列表中高亮显示指定的位置
    function highlightLocationInList(name) {
        const listItems = document.querySelectorAll('.list-location-item');
        listItems.forEach(item => {
            const itemName = item.getAttribute('data-name');
            if (itemName === name) {
                // 移除所有项的active类
                listItems.forEach(i => i.classList.remove('active'));
                // 添加active类到匹配项
                item.classList.add('active');
                // 滚动到视图中
                item.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    }
    
    // 加载位置坐标数据
    function loadLocations(category = 'all') {
        // 清空现有标记
        clearMarkers();
        
        // 更新列表标题
        updateListTitle(category);
        
        // 显示加载中
        document.getElementById('location-list').innerHTML = `
            <li class="list-group-item text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
            </li>
        `;
        
        // 从API获取坐标数据
        fetch(`/api/coordinates?category=${category}`)
            .then(response => response.json())
            .then(data => {
                // 保存当前位置数据
                currentLocations = data;
                
                // 添加标记到地图
                addMarkers(data);
                
                // 更新位置列表
                updateLocationList(data);
            })
            .catch(error => {
                console.error('获取坐标数据失败:', error);
                document.getElementById('location-list').innerHTML = `
                    <li class="list-group-item text-center text-danger">
                        <i class="fas fa-exclamation-circle"></i> 加载数据失败
                    </li>
                `;
            });
    }
    
    // 添加标记到地图
    function addMarkers(locations) {
        locations.forEach(location => {
            // 创建标记
            const point = new BMap.Point(location.lng, location.lat);
            const marker = new BMap.Marker(point);
            
            // 根据类型设置不同的图标颜色
            let iconType = location.type || 'other';
            if (iconType === 'traffic') iconType = 'traffic';
            if (iconType === 'shopping') iconType = 'shopping';
            if (iconType === 'medical') iconType = 'medical';
            
            const color = typeColors[iconType] || typeColors.other;
            
            // 添加点击事件
            marker.addEventListener('click', function() {
                showLocationInfo(location);
            });
            
            // 添加到地图
            map.addOverlay(marker);
            
            // 保存标记引用
            markers.push(marker);
        });
        
        // 如果有位置，调整地图视野以包含所有标记
        if (locations.length > 0) {
            map.setViewport(markers.map(marker => marker.getPosition()));
        }
    }
    
    // 清除地图上的所有标记
    function clearMarkers() {
        markers.forEach(marker => {
            map.removeOverlay(marker);
        });
        markers = [];
    }
    
    // 初始化事件监听
    function initEventListeners() {
        // 位置类型筛选
        document.getElementById('location-type').addEventListener('change', function() {
            loadLocations(this.value);
        });
        
        // 地图搜索
        document.getElementById('map-search-btn').addEventListener('click', searchLocation);
        document.getElementById('map-search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchLocation();
            }
        });
    }
    
    // 搜索位置
    function searchLocation() {
        const searchInput = document.getElementById('map-search-input');
        const keyword = searchInput.value.trim();
        
        if (!keyword) return;
        
        // 在当前位置中搜索
        const results = currentLocations.filter(location => 
            location.name.toLowerCase().includes(keyword.toLowerCase()) ||
            location.address.toLowerCase().includes(keyword.toLowerCase()) ||
            (location.description && location.description.toLowerCase().includes(keyword.toLowerCase()))
        );
        
        // 更新位置列表
        updateLocationList(results);
        
        // 如果有结果，聚焦到第一个结果
        if (results.length > 0) {
            map.centerAndZoom(new BMap.Point(results[0].lng, results[0].lat), 15);
            showLocationInfo(results[0]);
        }
    }
    
    // 显示位置信息
    function showLocationInfo(location) {
        const locationInfo = document.getElementById('location-info');
        const locationTitle = document.getElementById('selected-location-title');
        
        // 更新标题
        locationTitle.textContent = location.name;
        
        // 构建信息HTML
        let html = `
            <h5>${location.name}</h5>
            <p><i class="fas fa-map-marker-alt text-danger me-2"></i>${location.address}</p>
        `;
        
        if (location.description) {
            html += `<p><i class="fas fa-info-circle text-info me-2"></i>${location.description}</p>`;
        }
        
        // 根据位置类型添加不同的信息
        if (location.type === 'attraction') {
            if (location.opening_hours) {
                html += `<p><i class="fas fa-clock text-success me-2"></i>开放时间: ${location.opening_hours}</p>`;
            }
            if (location.ticket_price) {
                html += `<p><i class="fas fa-ticket-alt text-primary me-2"></i>门票: ${location.ticket_price}</p>`;
            }
        } else if (location.type === 'food') {
            if (location.rating) {
                html += `<p><i class="fas fa-star text-warning me-2"></i>评分: ${location.rating}</p>`;
            }
        }
        
        // 更新信息区域
        locationInfo.innerHTML = html;
        
        // 居中显示位置
        map.centerAndZoom(new BMap.Point(location.lng, location.lat), 15);
    }
    
    // 更新位置列表
    function updateLocationList(locations) {
        const locationList = document.getElementById('location-list');
        
        if (locations.length === 0) {
            locationList.innerHTML = `
                <li class="list-group-item text-center text-muted">
                    没有找到匹配的位置
                </li>
            `;
            return;
        }
        
        let html = '';
        locations.forEach((location, index) => {
            // 获取图标类型
            let iconClass = 'fa-map-marker-alt';
            let iconColor = 'text-secondary';
            
            if (location.type === 'attraction') {
                iconClass = 'fa-landmark';
                iconColor = 'text-danger';
            } else if (location.type === 'food') {
                iconClass = 'fa-utensils';
                iconColor = 'text-primary';
            } else if (location.type === 'traffic') {
                iconClass = 'fa-bus';
                iconColor = 'text-success';
            } else if (location.type === 'shopping') {
                iconClass = 'fa-shopping-bag';
                iconColor = 'text-warning';
            } else if (location.type === 'medical') {
                iconClass = 'fa-hospital';
                iconColor = 'text-info';
            }
            
            html += `
                <li class="list-group-item list-location-item" data-index="${index}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">
                            <i class="fas ${iconClass} ${iconColor} me-2"></i>${location.name}
                        </h6>
                    </div>
                    <small class="text-muted d-block text-truncate">${location.address}</small>
                </li>
            `;
        });
        
        locationList.innerHTML = html;
        
        // 添加点击事件
        document.querySelectorAll('.list-location-item').forEach(item => {
            item.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                const location = locations[index];
                showLocationInfo(location);
            });
        });
    }
    
    // 更新列表标题
    function updateListTitle(category) {
        const title = document.getElementById('location-list-title');
        
        switch(category) {
            case 'attraction':
                title.textContent = '景点位置';
                break;
            case 'food':
                title.textContent = '美食位置';
                break;
            case 'traffic':
                title.textContent = '交通位置';
                break;
            case 'shopping':
                title.textContent = '购物位置';
                break;
            case 'medical':
                title.textContent = '医疗位置';
                break;
            default:
                title.textContent = '所有位置';
        }
    }
    
    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        // 初始化地图
        initMap();
        
        // 加载所有位置
        loadLocations();
        
        // 设置类型过滤器事件
        document.getElementById('location-type').addEventListener('change', function() {
            filterLocations();
        });
        
        // 设置搜索框事件
        document.getElementById('search-locations').addEventListener('input', function() {
            filterLocations();
        });
    });
</script>
{% endblock %} 